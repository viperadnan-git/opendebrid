{{define "content"}}
{{template "nav" .}}
<main class="container">
    <div class="toolbar">
        <h2>Downloads</h2>
        <div class="toolbar-spacer"></div>
        <button class="btn-accent btn-sm" onclick="document.getElementById('add-dialog').showModal()">+ Add Download</button>
    </div>

    <div class="engine-tabs" id="engine-tabs">
        <button class="active" onclick="setEngine(this, '')">All</button>
        {{range .Engines}}
        <button onclick="setEngine(this, '{{.}}')">{{.}}</button>
        {{end}}
    </div>

    <div class="table-wrap" id="jobs-list"
         hx-get="/htmx/jobs"
         hx-trigger="load, refresh, every 5s"
         hx-swap="innerHTML">
        <div class="loading" aria-busy="true">Loading...</div>
    </div>

    <dialog id="add-dialog" x-data="{ url: '', engine: '{{with index .Engines 0}}{{.}}{{end}}', loading: false, error: '' }">
        <article>
            <header>
                <button aria-label="Close" rel="prev" onclick="this.closest('dialog').close()"></button>
                <h3>Add Download</h3>
            </header>
            <form @submit.prevent="
                loading = true; error = '';
                fetch('/api/v1/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({url: url, engine: engine})
                })
                .then(r => r.json())
                .then(data => {
                    loading = false;
                    if (data.job_id) {
                        document.getElementById('add-dialog').close();
                        url = '';
                        htmx.trigger('#jobs-list', 'refresh');
                    } else {
                        error = data.detail || 'Failed to add download';
                    }
                })
                .catch(() => { loading = false; error = 'Request failed'; })
            ">
                <div x-show="error" class="flash flash-error" x-text="error" x-cloak></div>
                <label for="dl-engine">Engine</label>
                <select id="dl-engine" x-model="engine">
                    {{range .Engines}}
                    <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
                <label for="dl-url">URL</label>
                <input type="text" id="dl-url" x-model="url" placeholder="https://... or magnet:?xt=..." required>
                <button type="submit" class="btn-accent" style="width:100%;margin-top:0.5rem" :aria-busy="loading">Add Download</button>
            </form>
        </article>
    </dialog>

    <script>
    function setEngine(btn, engine) {
        document.querySelectorAll('#engine-tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const el = document.getElementById('jobs-list');
        el.setAttribute('hx-get', '/htmx/jobs' + (engine ? '?engine=' + engine : ''));
        htmx.process(el);
        htmx.trigger(el, 'refresh');
    }
    </script>
</main>
{{end}}
