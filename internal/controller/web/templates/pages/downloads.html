{{define "content"}}
{{template "nav" .}}
<main class="container" x-data="{
    jobs: [],
    loading: true,
    engine: '',
    async load() {
        const q = this.engine ? '?engine=' + this.engine : '';
        const resp = await api('/downloads' + q);
        if (resp.success) this.jobs = resp.data;
        this.loading = false;
    },
    setEngine(eng) {
        this.engine = eng;
        this.load();
    },
    async deleteJob(id) {
        if (!confirm('Delete this download?')) return;
        const resp = await api('/downloads/' + id, { method: 'DELETE' });
        if (resp.success) this.jobs = this.jobs.filter(j => j.id !== id);
    },
    async retryJob(id) {
        const resp = await api('/downloads/' + id + '/retry', { method: 'POST' });
        if (resp.success) window.location.href = '/downloads/' + resp.data.download_id;
    }
}" x-init="load(); setInterval(() => load(), 5000)">
    <div class="toolbar">
        <h2>Downloads</h2>
        <div class="toolbar-spacer"></div>
        <button class="btn-accent btn-sm" onclick="document.getElementById('add-dialog').showModal()">+ Add Download</button>
    </div>

    <div class="engine-tabs">
        <button :class="engine === '' && 'active'" @click="setEngine('')">All</button>
        {{range .Engines}}
        <button :class="engine === '{{.}}' && 'active'" @click="setEngine('{{.}}')">{{.}}</button>
        {{end}}
    </div>

    <div class="table-wrap">
        <div x-show="loading" class="loading" aria-busy="true">Loading...</div>
        <table x-show="!loading" role="grid" style="min-width:560px">
            <colgroup><col style="width:33%"><col style="width:10%"><col style="width:12%"><col style="width:26%"><col style="width:19%"></colgroup>
            <thead><tr><th>Name</th><th>Engine</th><th>Status</th><th>Progress</th><th>Actions</th></tr></thead>
            <tbody>
                <template x-if="jobs.length === 0 && !loading">
                    <tr><td colspan="5" class="empty-state">No jobs yet. Add a download above.</td></tr>
                </template>
                <template x-for="j in jobs" :key="j.id">
                    <tr>
                        <td class="cell-truncate" :title="j.url">
                            <a :href="'/downloads/' + j.id" class="cell-link">
                                <div class="cell-mono" x-text="truncate(j.name || j.url, 50)"></div>
                                <template x-if="j.size">
                                    <div style="font-size:0.65rem;color:var(--pico-muted-color)" x-text="fmtBytes(j.size)"></div>
                                </template>
                            </a>
                        </td>
                        <td><span class="tag" x-text="j.engine"></span></td>
                        <td><span class="status" :class="'status-' + j.status" x-text="j.status"></span></td>
                        <td>
                            <template x-if="j.status === 'active' || j.status === 'queued'">
                                <div>
                                    <progress :value="j.progress" max="1" style="width:100%;margin-bottom:0.2rem"></progress>
                                    <div class="cell-mono" style="font-size:0.7rem;color:var(--pico-muted-color)">
                                        <span x-text="(j.progress * 100).toFixed(1) + '%'"></span>
                                        <template x-if="j.speed > 0"><span x-text="' | ' + fmtBytes(j.speed) + '/s'"></span></template>
                                        <template x-if="j.eta > 0"><span x-text="' | ' + fmtDuration(j.eta)"></span></template>
                                    </div>
                                </div>
                            </template>
                            <template x-if="j.status === 'completed'">
                                <span class="cell-mono" style="font-size:0.75rem;color:var(--accent)">Done</span>
                            </template>
                            <template x-if="j.status === 'failed'">
                                <span class="cell-mono" style="font-size:0.7rem;color:var(--pico-del-color)" x-text="truncate(j.error || 'Failed', 30)"></span>
                            </template>
                            <template x-if="j.status === 'cancelled'">
                                <span class="cell-mono text-muted" style="font-size:0.75rem">Cancelled</span>
                            </template>
                        </td>
                        <td>
                            <div style="display:flex;gap:0.35rem;flex-wrap:wrap">
                                <template x-if="j.status === 'failed' || j.status === 'cancelled'">
                                    <button class="outline btn-sm" @click="retryJob(j.id)">â†º Retry</button>
                                </template>
                                <button class="outline btn-sm btn-danger" @click="deleteJob(j.id)">Delete</button>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <dialog id="add-dialog" x-data="{ url: '', engine: '{{with index .Engines 0}}{{.}}{{end}}', addLoading: false, error: '' }">
        <article>
            <header>
                <button aria-label="Close" rel="prev" onclick="this.closest('dialog').close()"></button>
                <h3>Add Download</h3>
            </header>
            <form @submit.prevent="
                addLoading = true; error = '';
                api('/downloads', {
                    method: 'POST',
                    body: JSON.stringify({url, engine})
                })
                .then(resp => {
                    addLoading = false;
                    if (resp.success) {
                        document.getElementById('add-dialog').close();
                        url = '';
                    } else {
                        error = resp.error || 'Failed to add download';
                    }
                })
                .catch(() => { addLoading = false; error = 'Request failed'; })
            ">
                <div x-show="error" class="flash flash-error" x-text="error" x-cloak></div>
                <label for="dl-engine">Engine</label>
                <select id="dl-engine" x-model="engine">
                    {{range .Engines}}
                    <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
                <label for="dl-url">URL</label>
                <input type="text" id="dl-url" x-model="url" placeholder="https://... or magnet:?xt=..." required>
                <button type="submit" class="btn-accent" style="width:100%;margin-top:0.5rem" :aria-busy="addLoading">Add Download</button>
            </form>
        </article>
    </dialog>
</main>
{{end}}
