{{define "content"}}
{{template "nav" .}}
<main class="container" x-data="{
    jobs: [],
    stats: null,
    loading: true,
    async load() {
        const [jobsResp, statsResp] = await Promise.all([
            api('/downloads?limit=10'),
            api('/stats')
        ]);
        if (jobsResp.success) this.jobs = jobsResp.data;
        if (statsResp.success) this.stats = statsResp.data;
        this.loading = false;
    }
}" x-init="load(); setInterval(() => load(), 5000)">
    <h2>Dashboard</h2>

    {{if .IsAdmin}}
    <div class="grid-stats" x-show="loading" aria-hidden="true">
        <article class="stat-card">
            <div class="skel-line" style="width:52%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:38%;height:24px;margin-bottom:0.35rem"></div>
            <div class="skel-line" style="width:62%;height:8px"></div>
        </article>
        <article class="stat-card">
            <div class="skel-line" style="width:40%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:30%;height:24px;margin-bottom:0.35rem"></div>
            <div class="skel-line" style="width:55%;height:8px"></div>
        </article>
        <article class="stat-card">
            <div class="skel-line" style="width:36%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:28%;height:24px;margin-bottom:0.35rem"></div>
            <div class="skel-line" style="width:50%;height:8px"></div>
        </article>
        <article class="stat-card">
            <div class="skel-line" style="width:30%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:55%;height:24px;margin-bottom:0.35rem"></div>
            <div class="skel-line" style="width:68%;height:8px"></div>
        </article>
    </div>
    <div class="grid-stats" x-show="!loading">
        <article class="stat-card">
            <div class="stat-label">Active Downloads</div>
            <div class="stat-value">
                <span x-text="stats?.admin?.active_jobs ?? 0">0</span><span class="unit"> system-wide</span>
            </div>
        </article>
        <article class="stat-card">
            <div class="stat-label">Nodes</div>
            <div class="stat-value">
                <span x-text="stats?.admin?.online_nodes ?? 0">0</span><span class="unit"> / <span x-text="stats?.admin?.total_nodes ?? 0">0</span> online</span>
            </div>
        </article>
        <article class="stat-card">
            <div class="stat-label">Users</div>
            <div class="stat-value">
                <span x-text="stats?.admin?.total_users ?? 0">0</span><span class="unit"> registered</span>
            </div>
        </article>
        <article class="stat-card">
            <div class="stat-label">Disk</div>
            <div class="stat-value" x-text="fmtBytes(stats?.admin?.disk_available ?? 0)">0</div>
            <div style="margin-top:0.25rem">
                <span class="unit" x-text="'of ' + fmtBytes(stats?.admin?.disk_total ?? 0) + ' free'"></span>
            </div>
        </article>
    </div>
    {{else}}
    <div class="grid-stats" x-show="loading" aria-hidden="true">
        <article class="stat-card">
            <div class="skel-line" style="width:40%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:28%;height:24px;margin-bottom:0.35rem"></div>
            <div class="skel-line" style="width:52%;height:8px"></div>
        </article>
        <article class="stat-card">
            <div class="skel-line" style="width:55%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:32%;height:24px"></div>
        </article>
        <article class="stat-card">
            <div class="skel-line" style="width:62%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:30%;height:24px"></div>
        </article>
        <article class="stat-card">
            <div class="skel-line" style="width:44%;height:8px;margin-bottom:0.65rem"></div>
            <div class="skel-line" style="width:20%;height:24px;margin-bottom:0.45rem"></div>
            <div style="display:flex;gap:0.35rem">
                <div class="skel-line" style="width:38px;height:18px;border-radius:3px"></div>
                <div class="skel-line" style="width:38px;height:18px;border-radius:3px"></div>
            </div>
        </article>
    </div>
    <div class="grid-stats" x-show="!loading">
        <article class="stat-card">
            <div class="stat-label">Active</div>
            <div class="stat-value">
                <span x-text="stats?.user?.active_jobs ?? 0">0</span><span class="unit"> downloading</span>
            </div>
        </article>
        <article class="stat-card">
            <div class="stat-label">Completed</div>
            <div class="stat-value">
                <span x-text="stats?.user?.completed_jobs ?? 0">0</span>
            </div>
        </article>
        <article class="stat-card">
            <div class="stat-label">Total Downloads</div>
            <div class="stat-value">
                <span x-text="stats?.user?.total_jobs ?? 0">0</span>
            </div>
        </article>
        <article class="stat-card">
            <div class="stat-label">Engines</div>
            <div class="stat-value">
                {{len .Engines}}<span class="unit"> available</span>
            </div>
            <div style="margin-top:0.25rem">
                {{range .Engines}}<span class="tag">{{.}}</span> {{end}}
            </div>
        </article>
    </div>
    {{end}}

    <h3>Recent Downloads</h3>
    <div class="table-wrap">
        <div x-show="loading" class="loading" aria-busy="true">Loading...</div>
        <table x-show="!loading" role="grid" style="min-width:500px">
            <colgroup><col style="width:45%"><col style="width:12%"><col style="width:15%"><col style="width:28%"></colgroup>
            <thead><tr><th>Name</th><th>Engine</th><th>Status</th><th>Progress</th></tr></thead>
            <tbody>
                <template x-if="jobs.length === 0 && !loading">
                    <tr><td colspan="4" class="empty-state">Add downloads from the <a href="/downloads">downloads page</a></td></tr>
                </template>
                <template x-for="j in jobs" :key="j.id">
                    <tr>
                        <td class="cell-truncate" :title="j.url">
                            <a :href="'/downloads/' + j.id" class="cell-link">
                                <div class="cell-mono" x-text="truncate(j.name || j.url, 50)"></div>
                                <template x-if="j.size">
                                    <div style="font-size:0.65rem;color:var(--pico-muted-color)" x-text="fmtBytes(j.size)"></div>
                                </template>
                            </a>
                        </td>
                        <td><span class="tag" x-text="j.engine"></span></td>
                        <td><span class="status" :class="'status-' + j.status" x-text="j.status"></span></td>
                        <td>
                            <template x-if="j.status === 'active' || j.status === 'queued'">
                                <div>
                                    <progress :value="j.progress" max="1" style="width:100%;margin-bottom:0.2rem"></progress>
                                    <div class="cell-mono" style="font-size:0.7rem;color:var(--pico-muted-color)">
                                        <span x-text="(j.progress * 100).toFixed(1) + '%'"></span>
                                        <template x-if="j.speed > 0"><span x-text="' | ' + fmtBytes(j.speed) + '/s'"></span></template>
                                    </div>
                                </div>
                            </template>
                            <template x-if="j.status === 'completed'">
                                <span class="cell-mono" style="font-size:0.75rem;color:var(--accent)">Done</span>
                            </template>
                            <template x-if="j.status === 'failed'">
                                <span class="cell-mono" style="font-size:0.7rem;color:var(--pico-del-color)" x-text="truncate(j.error || 'Failed', 30)"></span>
                            </template>
                            <template x-if="j.status === 'inactive'">
                                <span class="cell-mono" style="font-size:0.7rem;color:var(--pico-muted-color)">Node offline</span>
                            </template>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
</main>
{{end}}
