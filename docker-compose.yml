services:
  controller:
    build: .
    restart: unless-stopped
    environment:
      OPENDEBRID_DATABASE_URL: ${OPENDEBRID_DATABASE_URL}
      OPENDEBRID_SERVER_URL: "http://localhost:8080"
      OPENDEBRID_AUTH_ADMIN_PASSWORD: ${OPENDEBRID_ADMIN_PASSWORD:-admin}
      OPENDEBRID_NODE_AUTH_TOKEN: ${OPENDEBRID_NODE_AUTH_TOKEN}
      OPENDEBRID_NODE_ID: controller
      OPENDEBRID_LOGGING_LEVEL: ${OPENDEBRID_LOG_LEVEL:-debug}
    ports:
      - "8080:8080"               # HTTP + gRPC (multiplexed)
      - "6800:6800"               # aria2 RPC
      - "6881-6999:6881-6999"     # BitTorrent
      - "6881-6999:6881-6999/udp" # DHT
    volumes:
      - ./config.toml:/etc/opendebrid/config.toml:ro
      - downloads-controller:/data/downloads
    command: ["controller", "--config", "/etc/opendebrid/config.toml"]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  worker:
    build: .
    restart: unless-stopped
    depends_on:
      controller:
        condition: service_healthy
    environment:
      OPENDEBRID_CONTROLLER_URL: "http://controller:8080"
      OPENDEBRID_SERVER_URL: "http://worker:8080"
      OPENDEBRID_NODE_AUTH_TOKEN: ${OPENDEBRID_NODE_AUTH_TOKEN}
      OPENDEBRID_NODE_ID: worker-1
      OPENDEBRID_LOGGING_LEVEL: ${OPENDEBRID_LOG_LEVEL:-debug}
    ports:
      - "8082:8080" # HTTP (file serving only)
    volumes:
      - downloads-worker:/data/downloads
    command: ["worker"]

  # Uncomment below to run a local PostgreSQL instance instead of external (e.g. Supabase).
  # postgres:
  #   image: postgres:16-alpine
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: opendebrid
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  #     POSTGRES_DB: opendebrid
  #   volumes:
  #     - pgdata:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U opendebrid"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

volumes:
  downloads-controller:
  downloads-worker:
