services:
  controller:
    build:
      context: .
      dockerfile: docker/Dockerfile.controller
    restart: unless-stopped
    environment:
      OD_DATABASE_URL: ${OD_DATABASE_URL}
      OD_AUTH_JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      OD_AUTH_ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
      OD_NODE_WORKER_AUTH_TOKEN: ${WORKER_AUTH_TOKEN:-worker-secret}
      OD_LOGGING_LEVEL: ${LOG_LEVEL:-debug}
    ports:
      - "8080:8080"               # HTTP (API + Web UI + file downloads)
      - "9090:9090"               # gRPC
      - "6800:6800"               # aria2 RPC
      - "6881-6999:6881-6999"     # BitTorrent
      - "6881-6999:6881-6999/udp" # DHT
    volumes:
      - ./config.toml:/etc/opendebrid/config.toml:ro
      - downloads-controller:/data/downloads
    command: ["controller", "--config", "/etc/opendebrid/config.toml"]

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
    restart: unless-stopped
    depends_on:
      - controller
    environment:
      CONTROLLER_URL: "controller:9090"
      CONTROLLER_TOKEN: ${WORKER_AUTH_TOKEN:-worker-secret}
      OD_LOGGING_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "8082:8080" # HTTP (file serving only)
    volumes:
      - downloads-worker:/data/downloads

  # Uncomment below to run a local PostgreSQL instance instead of external (e.g. Supabase).
  # postgres:
  #   image: postgres:16-alpine
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: opendebrid
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  #     POSTGRES_DB: opendebrid
  #   volumes:
  #     - pgdata:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U opendebrid"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

volumes:
  downloads-controller:
  downloads-worker:
